<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NutriTracker - Sign In</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="layout">
    <div class="shell" style="max-width: 520px;">
      <div class="auth-hero">
        <div class="app-badge" aria-hidden="true">ðŸ¥—</div>
        <h1 class="h1" style="text-align:center;">Welcome Back</h1>
        <p class="muted" style="text-align:center;">Track your nutrition journey</p>
      </div>

      <div class="card auth-card">
        <div class="card-header">
          <div class="tabs" role="tablist">
            <button class="tab active" id="tabLogin" type="button" role="tab" aria-selected="true">Sign In</button>
            <button class="tab" id="tabRegister" type="button" role="tab" aria-selected="false">Sign Up</button>
          </div>
        </div>

        <div class="card-body">
          <!-- LOGIN -->
          <form id="loginForm" class="stack" autocomplete="on">
            <div>
              <label class="label" for="login_email">Email</label>
              <input class="input" id="login_email" type="email" placeholder="you@example.com" required />
            </div>
            <div>
              <label class="label" for="login_password">Password</label>
              <input class="input" id="login_password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
            </div>
            <button class="btn" type="submit">Sign In</button>

            <div class="divider-row"><span class="muted">or</span></div>
            <button class="btn btn-outline" type="button" id="googleBtn" disabled title="Not implemented yet">Continue with Google</button>
          </form>

          <!-- REGISTER (2 steps: credentials -> profile) -->
          <form id="registerForm" class="stack hidden" autocomplete="on">
            <div id="regStep1" class="stack">
              <div>
                <label class="label" for="reg_username">Username</label>
                <input class="input" id="reg_username" placeholder="e.g. andrei" required />
              </div>
              <div>
                <label class="label" for="reg_email">Email</label>
                <input class="input" id="reg_email" type="email" placeholder="you@example.com" required />
              </div>
              <div>
                <label class="label" for="reg_password">Password</label>
                <input class="input" id="reg_password" type="password" placeholder="Create a password" required />
              </div>

              <button class="btn" type="button" id="regNextBtn">Next: Create profile</button>
              <p class="muted" style="margin:0;">Your profile is required before we create your account.</p>
            </div>

            <div id="regStep2" class="stack hidden">
              <div class="row-between" style="align-items:center;">
                <div>
                  <div style="font-weight:900;">Create your profile</div>
                  <div class="muted">Weâ€™ll use this to set your goals.</div>
                </div>
                <button class="btn btn-outline" type="button" id="regBackBtn">Back</button>
              </div>

              <div class="form-grid">
                <div>
                  <label class="label" for="reg_age">Age</label>
                  <input class="input" id="reg_age" type="number" min="1" max="120" step="1" required />
                </div>
                <div>
                  <label class="label" for="reg_gender">Gender</label>
                  <select class="input" id="reg_gender" required>
                    <option value="female">Female</option>
                    <option value="male">Male</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div>
                  <label class="label" for="reg_height">Height (cm)</label>
                  <input class="input" id="reg_height" type="number" min="50" max="260" step="1" required />
                </div>
                <div>
                  <label class="label" for="reg_weight">Weight (kg)</label>
                  <input class="input" id="reg_weight" type="number" min="20" max="400" step="0.1" required />
                </div>
                <div>
                  <label class="label" for="reg_activity">Activity level</label>
                  <select class="input" id="reg_activity" required>
                    <option value="sedentary">Sedentary</option>
                    <option value="light">Light</option>
                    <option value="moderate">Moderate</option>
                    <option value="active">Active</option>
                    <option value="very_active">Very active</option>
                  </select>
                </div>
                <div>
                  <label class="label" for="reg_goal">Daily calorie goal</label>
                  <input class="input" id="reg_goal" type="number" min="500" max="10000" step="1" required />
                </div>
              </div>

              <button class="btn" type="submit">Create account</button>
              <p class="muted" style="margin:0;">By signing up you agree to your own future self eating more veggies.</p>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="auth.js"></script>
  <script>
    // Tabs
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');

    function setTab(which) {
      const isLogin = which === 'login';
      tabLogin.classList.toggle('active', isLogin);
      tabRegister.classList.toggle('active', !isLogin);
      tabLogin.setAttribute('aria-selected', String(isLogin));
      tabRegister.setAttribute('aria-selected', String(!isLogin));
      loginForm.classList.toggle('hidden', !isLogin);
      registerForm.classList.toggle('hidden', isLogin);
    }

    tabLogin.addEventListener('click', () => window.location.href = 'login.html');
    tabRegister.addEventListener('click', () => setTab('register'));
    setTab("register");

    // Registration 2-step flow
    const regStep1 = document.getElementById('regStep1');
    const regStep2 = document.getElementById('regStep2');
    const regNextBtn = document.getElementById('regNextBtn');
    const regBackBtn = document.getElementById('regBackBtn');

    function showRegStep(step) {
      const isStep1 = step === 1;
      regStep1.classList.toggle('hidden', !isStep1);
      regStep2.classList.toggle('hidden', isStep1);
    }
    showRegStep(1);

    regNextBtn.addEventListener('click', () => {
      // minimal validation before moving on
      if (!reg_username.value || !reg_email.value || !reg_password.value) {
        alert('Please fill username, email, and password first.');
        return;
      }
      showRegStep(2);
    });

    regBackBtn.addEventListener('click', () => showRegStep(1));

    // API calls (same logic as your original file)
    async function login(e) {
      e.preventDefault();
      const email = login_email.value;
      const password = login_password.value;

      const res = await fetch('http://localhost:3000/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      if (!res.ok) return alert('Login failed');
      const data = await res.json();
      setToken(data.token);
      window.location.href = 'dashboard.html';
    }

    async function register(e) {
      e.preventDefault();
      const res = await fetch('http://localhost:3000/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: reg_username.value,
          email: reg_email.value,
          password: reg_password.value,

          // profile (required)
          age: Number(reg_age.value),
          gender: reg_gender.value,
          height_cm: Number(reg_height.value),
          weight_kg: Number(reg_weight.value),
          activity_level: reg_activity.value,
          calorie_goal: Number(reg_goal.value)
        })
      });

      if (!res.ok) return alert('Registration failed');
      alert('Registered. You can now sign in.');
      window.location.href='login.html';
    }

    loginForm.addEventListener('submit', login);
    registerForm.addEventListener('submit', register);
  </script>
</body>
</html>
